<?php
$widthImg = 650;
$heightImg = 450;
$max_upload = min(ini_get('post_max_size'), ini_get('upload_max_filesize'));
$max_upload = str_replace('M', '', $max_upload);
$max_upload = ($max_upload * 1024) * 1024;
?>

<script language="javascript" type="text/javascript">
    var widthImg = '<?= $widthImg?>';
    var heightImg = '<?= $heightImg?>';
    var maxUpload = '<?= $max_upload?>';

    function bytesToSize(bytes) {
        var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        if (bytes == 0) return '0 Byte';
        var i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));
        return Math.round(bytes / Math.pow(1024, i), 2) + ' ' + sizes[i];
    }

    function readURL(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('#previewImage').show();
                $('#previewIframe').show();
                $('#previewImage').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
        }
    }

    $(function () {
        $("#post").validationEngine();
        $(window).dblclick(function () {
            jQuery('#post').validationEngine('hide');
        });

        if ($('#previewImage').attr('src') == '') {
            $('#previewImage').hide();
        }

        var sizeMax = bytesToSize(maxUpload);
        var sizeMax = sizeMax.split(' ');
        $('#maxSizeFile').html('<strong><u>' + sizeMax[0] + '</u></strong> ' + sizeMax[1]);

        var _URL = window.URL || window.webkitURL;
        $("#news_image").change(function (e) {
            var file, img;
            var current = this;
            if ((file = this.files[0])) {
                img = new Image();
                img.onload = function () {
                    // if (file.size > maxUpload) {
                    //     alert($('#textSizeFile').text());
                    //     $('#news_image').val('');
                    //     $('#news_image').removeClass('validate[required]');
                    //     $('#news_image').addClass('validate[required]');
                    //     $('#previewImage').hide();
                    // } else if (this.width < widthImg || this.height < heightImg) {
                    //     alert($('#textWidthHeightFile').text());
                    //     $('#news_image').val('');
                    //     $('#news_image').removeClass('validate[required]');
                    //     $('#news_image').addClass('validate[required]');
                    //     $('#previewImage').hide();
                    // } else {
                    //     readURL(current);
                    // }

                    readURL(current);
                };

                img.src = _URL.createObjectURL(file);
            }

        });
    });
</script>

<div class="main-container">
    <div class="pd-ltr-20 xs-pd-20-10">
        <div class="pd-20 pb-40 card-box mb-30">
            <div class="row">
                <div class="col-md-12">

                    <div class="row">
                        <div class="col-6">
                          <h4 class="text-blue h4"><?= $title_page ?></h4>
                        </div>

                        <div class="col-6">
                          <div class="pull-right">
                            <nav aria-label="breadcrumb" role="navigation">
                              <ol class="breadcrumb pd-0">
                                <li class="breadcrumb-item"><a href="<?= LINK.'Index' ?>">หน้าแรก</a></li>
                                <li class="breadcrumb-item active" aria-current="page"><?= $title_page ?></li>
                              </ol>
                            </nav>
                          </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="main-box clearfix">
                                <div class="main-box-body clearfix">
                                    <form role="form" id="post" method="post"
                                          action="<?= $action_link . 'insert/' . $getForm['news_id'] ?>"
                                          enctype="multipart/form-data">
                                        <div class="form-group">
                                            <label><strong>หมวดหมู่ข่าว</strong></label>&nbsp;<span style="color: #f02323">*</span>
                                            <br>
                                            <select id="news_category" name="news_category" class="form-control">
                                                <?php foreach ($category as $ele): ?>
                                                    <option <?= $ele['category_id'] == $getForm['news_category'] ? ' selected ' : '' ?>
                                                            value="<?= $ele['category_id'] ?>">
                                                        <?= $ele['category_name'] ?>
                                                    </option>
                                                <?php endforeach; ?>
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label for="news_title"><strong>ชื่อข่าว</strong>&nbsp;<span
                                                        style="color: #f02323">*</span></label>
                                            <input type="text" class="form-control validate[required]" id="news_title"
                                                   name="news_title" placeholder="ชื่อข่าว"
                                                   value="<?= $getForm['news_title'] ?>" maxlength="250">
                                        </div>
                                        <div class="form-group">
                                            <label for="news_title_en"><strong>ชื่อข่าวภาษาอังกฤษ</strong></label>
                                            <input type="text" class="form-control" id="news_title_en"
                                                   name="news_title_en" placeholder="ชื่อข่าวภาษาอังกฤษ"
                                                   value="<?= $getForm['news_title_en'] ?>" maxlength="250">
                                        </div>
                                        <div class="form-group">
                                            <label for="news_description"><strong>รายละเอียดข่าว</strong></label>
                                            <script type="text/javascript">
                                                $(function () {

                                                        tinymce.init({
                                                            selector: ".tinymce",
                                                            width: '100%',
                                                            height: 350,
                                                            theme: "modern",
                                                            plugins: [
                                                                "searchreplace code ", "jbimages", "textcolor ", "link"
                                                            ],
                                                            toolbar: "insertfile undo redo | bold italic underline | alignleft aligncenter alignright alignjustify | fontsizeselect | link | forecolor |bullist numlist outdent indent |  jbimages",
                                                            relative_urls: false
                                                        });
                                                    }
                                                );
                                            </script>
                                            <textarea class="form-control tinymceEdit" id="news_description" name="news_description"
                                                      rows="3" placeholder="รายละเอียดข่าว"><?= $getForm['news_description'] ?></textarea>
                                        </div>
                                         <div class="form-group">
                                            <label for="news_description_en"><strong>รายละเอียดข่าวภาษาอังกฤษ</strong></label>
                                            <script type="text/javascript">
                                                $(function () {

                                                        tinymce.init({
                                                            selector: ".tinymce",
                                                            width: '100%',
                                                            height: 350,
                                                            theme: "modern",
                                                            plugins: [
                                                                "searchreplace code ", "jbimages", "textcolor ", "link"
                                                            ],
                                                            toolbar: "insertfile undo redo | bold italic underline | alignleft aligncenter alignright alignjustify | fontsizeselect | link | forecolor |bullist numlist outdent indent |  jbimages",
                                                            relative_urls: false
                                                        });
                                                    }
                                                );
                                            </script>
                                            <textarea class="form-control tinymceEdit" id="news_description_en" name="news_description_en"
                                                      rows="3" placeholder="รายละเอียดข่าวภาษาอังกฤษ"><?= $getForm['news_description_en'] ?></textarea>
                                        </div>
                                        <div class="col-md-12" ng-app="downloadApp" ng-controller="downloadController">
                                            <div class="row">
                                                <div class="col-md-12 text-center">
                                                    <h4>อัพโหลดไฟล์</h4>
                                                </div>
                                            </div>
                                            <!-- upload File -->
                                            <div class="row">
                                                <div class="col-md-12 mt-3" id="form_upload">
                                                    <div class="file_input" id="file_input_upload_file">
                                                        <div class="col-md-12 " id="input_upload_file">
                                                            <div class="form-group files">
                                                                <input data-ng-disabled="loading_upload" id="file_value" type="file" class="form-control uploadList" multiple="" onchange="angular.element(this).scope().fileImageData(this)">
                                                            </div>

                                                            <div class="row" data-ng-show="fileData.length > 0">
                                                                <div class="col-md-8 offset-2">
                                                                    <table class="table">
                                                                        <thead>
                                                                        <tr class="ckan">
                                                                            <th class="text-cetner w-5">ลำดับ</th>
                                                                            <th class="text-center">ไฟล์</th>
                                                                            <th class="text-center w-30"><i class="fa fa-cogs"></i></th>
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        <tr data-ng-repeat="value in fileData">
                                                                            <td data-ng-init="value.percent = 0" class="text-center" data-ng-bind="$index + 1"><pre data-ng-bind="value"></pre></td>
                                                                            <td data-ng-bind="value.name"></td>
                                                                            <td>
                                                                                <div class="progress mb-0">
                                                                                    <div class="progress-bar progress-bar-striped active progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" data-ng-style="{'width': (value.percent) + '%'}">
                                                                                        <span data-ng-bind="value.percent + '%'"></span>
                                                                                    </div>
                                                                                </div>
                                                                            </td>
                                                                        </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>

                                                            <div class="text-left "
                                                                 style='color:rgb(221, 84, 84);font-size: 16px; margin: 10px 0 0;'>
                                                                <span class="text_subportfile"
                                                                      style="white-space: normal;">
                                                                    {{allow_ext_text}}
                                                                </span>
                                                            </div>

                                                        </div>
                                                        <div class="col-md-12 mt-5" id="btn_upload_file">
                                                            <div style="text-align: right; margin-bottom: 20px; margin-top: -45px;">
                                                                <button id="upload-btn" type="button" class="btn btn-info"
                                                                        ng-click="upload()" data-ng-disabled="loading_upload"><i
                                                                            class="fa fa-upload"></i>&nbsp;&nbsp;<?= ('อัพโหลด') ?>
                                                                </button>
                                                            </div>
                                                        </div>

                                                    </div>

                                                </div>

                                                <div class="col-md-12" id="list_upload">
                                                    <div class="table-responsive">
                                                        <table id="tableSort" class="table table-hover">
                                                            <thead>
                                                            <tr>
                                                                <th class="text-center">ลำดับ</th>
                                                                <th class="text-center" colspan="2">ชื่อไฟล์</th>
                                                                <th class="text-center">กำหนดภาพปก</th>
                                                                <th class="text-center">#</th>
                                                            </tr>
                                                            </thead>
                                                            <tbody>
                                                            <tr id="{{rs.doc_id}}" order="{{($index + 1)}}" ng-repeat="rs in list">
                                                                <td style="width: 100px;" class="text-center">
                                                                    {{rs.s_order}}
                                                                </td>
                                                                <td style="width: 140px;">
                                                                    <img ng-show="allowImg(rs.ext)" src="<?= ROOT_PATH . 'file_upload/news/' ?>{{rs.file_name}}" style="width: 100px;">
                                                                </td>
                                                                <td >
                                                                    <a download="{{rs.file_name_original}}" href="<?= ROOT_PATH . 'file_upload/news/' ?>{{rs.file_name}}"
                                                                       target="_blank">
                                                                        {{rs.file_name_original}}
                                                                    </a>
                                                                    <input id="text"
                                                                           name="fld[]" type="hidden"
                                                                           value="{{rs}}">
                                                                </td>

                                                                <td class="text-center">
                                                                    <input id="is_cover_{{$index}}" data-ng-show="allowImg(rs.ext)" type="radio" name="is_cover" data-ng-click="setIsCover($index)"  data-ng-checked="{{rs.is_cover}}">
                                                                    <label for="is_cover_{{$index}}" data-ng-show="allowImg(rs.ext)" style="display: block">
                                                                        เลือกเป็นภาพปก
                                                                    </label>
                                                                </td>
                                                                <td class="text-center">
                                                                    <a ng-click="removeRemoteFile(rs)" class="btn btn-danger"
                                                                       role="button">
                                                                        <i class="fa fa-trash-o" style="color: #ffffff"></i>
                                                                    </a>
                                                                </td>
                                                            </tr>
                                                            <tr ng-show="list.length == 0 && !loading_upload">
                                                                <td colspan="10" class="text-center"> -- ไม่พบข้อมูล --</td>
                                                            </tr>
                                                            <tr ng-show="loading_upload">
                                                                <td colspan="10" class="text-center">
                                                                    <img src="<?= STATIC_PATH ?>images/loader.gif"
                                                                         style="max-height: 50px;" class="img-responsive" alt="Image">
                                                                </td>
                                                            </tr>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group mb-0" id="status">
                                            <label for="show_status1"><strong>สถานะ</strong></label>&nbsp;
                                            <span class="red">*</span>
                                            <div class="jumbotron radio p-3 pt-4">
                                                <input type="radio" name="show_status" id="show_status1"
                                                       value="1"
                                                    <?= ($getForm['show_status'] == null) || $getForm['show_status'] == 1 ? 'checked' : '' ?>>
                                                <label for="show_status1">
                                                    เผยแพร่
                                                </label>
                                                &nbsp;&nbsp;
                                                <input type="radio" name="show_status" id="show_status2"
                                                       value="2"
                                                    <?= isset($getForm) && $getForm['show_status'] == 2 ? 'checked' : '' ?>>
                                                <label for="show_status2">
                                                    ไม่เผยแพร่
                                                </label>
                                            </div>
                                        </div>

                                        <div class="form-group mb-0" id="date_show">
                                            <label for="type_date_show_1"><strong>กำหนดวันและเวลาในการแสดงผล</strong></label>&nbsp;
                                            <span class="red">*</span>
                                            <div class="jumbotron radio p-3 pt-4">
                                                <input type="radio" name="type_date_show" id="type_date_show_1"
                                                       value="1"
                                                    <?= ($getForm['type_date_show'] == null) || $getForm['type_date_show'] == 1 ? 'checked' : '' ?>>
                                                <label for="type_date_show_1">
                                                    แสดงผลตลอดเวลา
                                                </label>
                                                &nbsp;&nbsp;
                                                <input type="radio" name="type_date_show" id="type_date_show_2"
                                                       value="2"
                                                    <?= isset($getForm) && $getForm['type_date_show'] == 2 ? 'checked' : '' ?>>
                                                <label for="type_date_show_2">
                                                    แสดงผลตามช่วงเวลา
                                                </label>

                                                <div class="form-group row blockDate">
                                                    <label class="col-md-3 col-4 col-sm-3 my-auto text-right"><strong>ช่วงเวลา : </strong></label>
                                                    <div class="col-md-2 col-4 col-sm-3">
                                                        <input type="text" name="date_show_start"
                                                               class="form-control text-center" id="date_show_start"
                                                               value="<?= (!empty($getForm['date_show_start']) ? $getForm['date_show_start'] : '')?>" readonly
                                                               placeholder="วันที่เริ่มต้น" autocomplete="off">
                                                    </div>
                                                    <label class="col-md-1 col-4 col-sm-1 my-auto text-center"><strong>ถึง</strong></label>
                                                    <div class="col-md-2 col-8 col-sm-3">
                                                        <input type="text" name="date_show_end"
                                                               class="form-control text-center" id="date_show_end"
                                                               value="<?= (!empty($getForm['date_show_end']) ? $getForm['date_show_end'] : '')?>" readonly
                                                               placeholder="วันที่สิ้นสุด" autocomplete="off">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group text-center">
                                            <a href="<?= $action_link ?>">
                                                <button type="button" class="btn btn-danger"><i class="fa fa-times"></i>&nbsp;ยกเลิก
                                                </button>
                                            </a>
                                            &nbsp;&nbsp;
                                            <button type="submit" class="btn btn-success"><i class="fa fa-save"></i>&nbsp;บันทึก
                                            </button>

                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script language="javascript" type="text/javascript">

    $(document).on('change', '.btn-file :file', function () {
        var input = $(this),
            numFiles = input.get(0).files ? input.get(0).files.length : 1,
            label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
        input.trigger('fileselect', [numFiles, label]);
    });

    $(document).ready(function () {
        $('#dateShow').hide();

        $('#post').submit(function() {

          if($("input[name=show_status]:checked").val() == 1 && $("input[name=type_date_show]:checked").val() == 2) {
            var valid = $("#post").validationEngine('validate');

            if(valid) {
              var date_start = $('#date_show_start').val();
              var date_end = $('#date_show_end').val();

              if(date_start == '' || date_end == '') {
                alert('กรุณาระบุช่วงเวลาให้ครบ');
                return false;
              }

              if(date_start > date_end) {
                alert('กรุณาระบุช่วงเวลาให้ถูกต้อง');
                return false;
              }
            }
          }

        });

        var today = new Date();
        today.setDate(today.getDate() + 1);

        $.datetimepicker.setLocale('th');
        $('#date_show_start, #date_show_end').datetimepicker({
            timepicker: true,
            yearOffset: 543,
            format: 'd-m-Y H:i',
            scrollInput: false,
            scrollMonth: false,
            formatDate: 'd-m-Y H:i',
            defaultTime: '00:00',
        });

        $('#date_start_time, #date_end_time').datetimepicker({
            datepicker: false,
            format: 'H:i',
        });

        $("#post").validationEngine();

        $(window).dblclick(function () {
            jQuery('#post').validationEngine('hide');
        });

        $('#showStartDate').datepicker({
            format: 'dd-mm-yyyy',
            useCurrent: false,
        });

        $('#showEndDate').datepicker({
            format: 'dd-mm-yyyy',
            useCurrent: false,
        });

        $('#news_status1').on( "click", function() {
          if ($('#news_status1').is(':checked')) {
                $('#DurationOfShow').show();
            }
        });
        $('#news_status2').on( "click", function() {
          if ($('#news_status2').is(':checked')) {
                $('#DurationOfShow').hide();
                $('#dateShow').hide();
            }
        });

        var show_status = '<?= $getForm['show_status'] ?>';
        $('input[name=show_status]').each(function (index, el) {
            var check = $(this).prop("checked");
            if (check == true) {
              if($(this).val() == 1) {
                  $('#date_show').show(500);
              } else {
                  $('#date_show').hide(500);
              }
            }
        });

        $("input[name=show_status]").change(function () {
            if($(this).val() == 1) {
                $('#date_show').show(500);
            } else {
                $('#date_show').hide(500);
            }
        });

        $('.blockDate').hide(500);
        var type_date_show = '<?= $getForm['type_date_show'] ?>';
        $('input[name=type_date_show]').each(function (index, el) {
            var check = $(this).prop("checked");
            if (check == true) {
              if($(this).val() == 2) {
                  $('.blockDate').show(500);
              } else {
                  $('.blockDate').hide(500);
              }
            }
        });

        $("input[name=type_date_show]").change(function () {
            if($(this).val() == 2) {
                $('.blockDate').show(500);
            } else {
                $('.blockDate').hide(500);
            }
        });

        $('.btn-file :file').on('fileselect', function (event, numFiles, label) {

            var input = $(this).parents('.input-group').find(':text'),
                log = numFiles > 1 ? numFiles + ' files selected' : label;

            if (input.length) {
                input.val(log);
            } else {
                if (log)
                    alert(log);
            }

        });

        $("#linkGallery").select2({
            placeholder: 'ค้นหาแกลลอรี่...',
            ajax: {
                url: function (params) {
                    return '<?= $action_link?>getListGallery/' + params.term
                },
                dataType: 'json',
                delay: 250,
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            }
        });
    });

</script>

<script language="javascript" type="text/javascript">

    var downloadApp = angular.module("downloadApp", []);


    downloadApp.controller('downloadController', function ($scope, $http, $timeout, $rootScope) {

        var allow_ext = ['jpg', 'jpeg', 'png', 'gif', 'pdf', 'doc', 'docx' , 'pdf' , 'xls' , 'xlsx' , 'pptx' , 'ppt' , 'txt'];
        $scope.allow_ext_text = 'รองรับไฟล์นามสกุล * .' + allow_ext.join(', * .');
        var bytes_per_chunk = 1024 * 256;
        var curDOM = 0;
        var action_link = '<?= $action_link ?>';
        var token = '<?= $token ?>';
        var node = '';
        $scope.fileData = [];
        $scope.loading_upload = false;

        $scope.list = JSON.parse('<?= json_encode($getForm['list'])?>');

        var stringLength = 20;
        var no = 0;

        var stringArray = ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];

        $scope.generateToken = function (copyText) {
            var rndString = "";
            for (var i = 1; i < stringLength; i++) { 
                var rndNum = Math.ceil(Math.random() * stringArray.length) - 1;
                rndString = rndString + stringArray[rndNum];
            };
           return rndString;
        };

        $scope.copyText = function (copyText) {
            var $temp = $("<input>");
            $("body").append($temp);
            $temp.val(copyText).select();
            document.execCommand("copy");
            $temp.remove();

            alert('คัดลอก URL เรียบร้อยแล้ว');
        }

        $scope.upload = function () {
            fnc_travelNode();
        }

        var fnc_uploadChunkMuli = function (filesTotal, i) {
            var start = 0;
            var end = bytes_per_chunk;
            var file = node[curDOM].files[i];
            var blobs = [];
            var size = file.size;
            while (start < size) {
                blobs.push(file.slice(start, end));
                start = end;
                end = start + bytes_per_chunk;
            }

            var allBlobs = Object.keys(blobs).length;
            fnc_uploadChunk(blobs, allBlobs, file, filesTotal, i);
        }

        var fnc_travelNode = function () {
            var start = 0;
            var end = bytes_per_chunk;
            node = document.getElementsByClassName("uploadList");
            if (node[curDOM].value != '') {
                $scope.fileData = $('#file_value')[0].files;
                $scope.loading_upload = true;
                var filesTotal = node[curDOM].files.length;
                $('#upload-btn').prop('disabled', true);
                $('#upload_file').prop('disabled', true);
                var file = node[curDOM].files[0];
                var blobs = [];
                var size = file.size;

                while (start < size) {
                    blobs.push(file.slice(start, end));
                    start = end;
                    end = start + bytes_per_chunk;
                }

                var allBlobs = Object.keys(blobs).length;
                fnc_uploadChunk(blobs, allBlobs, file, filesTotal, 0);
            } else {
                curDOM = 0;
                alert("กรุณาเลือกแนบไฟล์เอกสารก่อนกดปุ่มอัพโหลด");

                $('#upload_file').val('');
                $('#file_value').val('');
                $('#upload-btn').prop('disabled', false);
                $('#upload_file').prop('disabled', false);
                $scope.loading_upload = false;

            }
        }

        var fnc_uploadChunk = function (blobs, allBlobs, file, filesTotal, fileNo) {
            var fileName = file.name;
            var fileType = file.type;
            var blob = blobs.shift();
            var remainBlobs = Object.keys(blobs).length;
            var n = allBlobs - remainBlobs;

            var xhr = new XMLHttpRequest();
            var fpercent = 0;

            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    fpercent = Math.floor(n / allBlobs * 100);
                    $scope.fileData[fileNo].percent = fpercent;

                    jQuery('.msg_percent').eq(curDOM).html(fpercent + '%');
                    jQuery('.barPercent').eq(curDOM).css('width', fpercent + '%');

                    if (remainBlobs > 0) {
                        fnc_uploadChunk(blobs, allBlobs, file, filesTotal, fileNo);
                    } else {
                        return fnc_createRemoteFile(file, filesTotal, fileNo);
                    }
                }
                if (xhr.readyState == 4 && xhr.status != 200) {
                    // $('#upload_file').val('');
                    // $('#file_value').val('');
                    $('#upload-btn').prop('disabled', false);
                    $('#upload_file').prop('disabled', false);
                    alert('การเชื่อมต่อผิดพลาด กรุณาอัพโหลดใหม่อีกครั้ง');
                }
            }

            xhr.open('POST', action_link + 'createChunk', true);
            xhr.setRequestHeader("Cache-Control", "private, no-cache, no-store, must-revalidate");
            xhr.setRequestHeader('X-FILE-NAME', unescape(encodeURIComponent(fileName)));
            xhr.setRequestHeader('X-TOKEN', token);
            xhr.setRequestHeader('Content-Type', fileType);
            xhr.send(blob);

        }

        var setNoTable = function () {
            for (var i = 0; i < angular.element('#tableSort tbody')[0].children.length; i++) {
                var keyData = angular.element('#tableSort tbody')[0].children[i].getAttribute('order') - 1;
                if(typeof $scope.list[keyData] !== "undefined") {
                    $scope.list[keyData].s_order = i + 1;
                    $scope.$apply();
                }
            }
        }

        var fnc_createRemoteFile = function (file, filesTotal, fileNo) {
            $http.post(action_link + 'createFile', {
                'file_name': file.name,
                'token': token
            }).then(function (res) {
                if (res.data.status == 'ok') {
                    var lengthData = $scope.list.length;
                    if(lengthData == 0) {
                        if($scope.allowImg(res.data.rdata['ext'])) {
                            res.data.rdata['is_cover'] = 1;
                        }
                    }
                    $scope.list.push(res.data.rdata);
                    // $('#upload_file').val('');
                    // $('#file_value').val('');
                    // no = no + 1;
                    if((filesTotal - 1) == fileNo) {
                        $scope.loading_upload = false;
                        $('#upload_file').val('');
                        $('#file_value').val('');
                        fnc_creteDnd();
                        setNoTable();
                    } else {
                        token = $scope.generateToken();
                        fnc_uploadChunkMuli(filesTotal, (fileNo + 1));
                    }

                } 

               
            }, function () {
                // $('#upload_file').val('');
                // $('#file_value').val('');
                $('#upload-btn').prop('disabled', false);
                $('#upload_file').prop('disabled', false);
                alert('การเชื่อมต่อผิดพลาด กรุณาอัพโหลดใหม่อีกครั้ง');
            });
        }

        $scope.removeRemoteFile = function (obj) {

            if (confirm('ยืนยันการลบข้อมูล')) {
                var index = fnc_findKey(obj);
                if (index >= -1) {
                    if (typeof (obj.doc_id) != 'undefined') {
                        $http.get(action_link + 'deleteFile/' + obj.doc_id).then(function (res) {
                            $scope.list.splice(index, 1);
                            $scope.$apply();

                        }, function (res) {
                            // alert('');
                        });

                    } else {
                        $.post(action_link + 'deleteFileByPath/',
                            {
                                path: obj.file_path + obj.file_name
                            },
                            function (data, status) {
                                $scope.list.splice(index, 1);
                                $scope.$apply();

                            }
                        );
                    }

                }
            }


        }

        $scope.fileImageData = function () {
            $scope.fileData = $('#file_value')[0].files;
            $scope.$apply();
        }

        var fnc_findKey = function (obj) {

            for (var prop in $scope.list) {

                if ($scope.list[prop] === obj) {
                    return prop;
                }
            }

            return -1;
        }

        $scope.validateFile = function (data) {

            var arr = data.value.split('.');
            var ext = arr[arr.length - 1].toLowerCase();


            if (allow_ext.indexOf(ext) >= 0) {
                return true;
            } else {
                alert($scope.allow_ext_text);
                data.value = '';
                return false;
            }
        }


        $scope.allowImg = function (ext) {
            var allow_img = ['jpg', 'jpeg', 'png', 'gif'];
            if (allow_img.indexOf(ext) >= 0) {
                return true;
            } else {
                return false;
            }
        }

        $scope.setIsCover = function (indexData) {
            angular.forEach($scope.list, function (value, key) {
                $scope.list[key]['is_cover'] = 0;
            });
            $scope.list[indexData]['is_cover'] = 1;
        }

        let fnc_creteDnd = function () {
            $timeout(function () {
                $('#tableSort tbody').tableDnD({
                    onDrop: function (table, row) {
                        var rows = table.rows;

                        for (var i = 0; i < rows.length; i++) {
                            var keyData = rows[i].getAttribute('order') - 1;
                            if(typeof $scope.list[keyData] !== "undefined") {
                                $scope.list[keyData].s_order = i + 1;
                                $scope.$apply();
                            }

                        }

                    }
                });
            }, 200);
        };
        fnc_creteDnd();

        $timeout(function () {
            setNoTable();
        }, 500);
    });


    function toObject(arr) {
        var rv = {};
        for (var i = 0; i < arr.length; ++i)
            if (arr[i] !== undefined)
                rv[i] = arr[i];
        return rv;
    }


</script>

<style type="text/css" media="screen">
    .btn-file {
        position: relative;
        overflow: hidden;
    }

    .btn-file input[type=file] {
        position: absolute;
        top: 0;
        right: 0;
        min-width: 100%;
        min-height: 100%;
        font-size: 100px;
        text-align: right;
        filter: alpha(opacity=0);
        opacity: 0;
        background: red;
        cursor: inherit;
        display: block;
    }

    .btn {
        /*font-family: 'Inter', sans-serif;*/
        letter-spacing: 0;
        font-weight: 500;
        padding: 0.600rem 1rem !important;
    }

    .progress {
        margin-bottom: 0px;
    }

    .progress-bar {
        color: #222;
    }

    /*.files input {*/
    /*    outline: 2px dashed #92b0b3;*/
    /*    outline-offset: -10px;*/
    /*    -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;*/
    /*    transition: outline-offset .15s ease-in-out, background-color .15s linear;*/
    /*    padding: 120px 0px 85px 37%;*/
    /*    text-align: center !important;*/
    /*    margin: 0;*/
    /*    width: 100% !important;*/
    /*}*/
    /*.files input:focus {     */
    /*    outline: 2px dashed #92b0b3;  outline-offset: -10px;*/
    /*    -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;*/
    /*    transition: outline-offset .15s ease-in-out, background-color .15s linear; border:1px solid #92b0b3;*/
    /* }*/
    /*.files { */
    /*    position:relative*/
    /*}*/
    /**/
    /*.files:after {  */
    /*    pointer-events: none;*/
    /*    position: absolute;*/
    /*    top: 40px;*/
    /*    left: 0;*/
    /*    width: 50px;*/
    /*    right: 0;*/
    /*    height: 56px;*/
    /*    content: "";*/
    /*    background-image: url(*/<?//= STATIC_PATH.'images/109612.png'?>/*);*/
    /*    display: block;*/
    /*    margin: 0 auto;*/
    /*    background-size: 100%;*/
    /*    background-repeat: no-repeat;*/
    /*}*/
    /*.color input { */
    /*    background-color:#f1f1f1;*/
    /*}*/
    /*.files:before {*/
    /*    position: absolute;*/
    /*    bottom: 10px;*/
    /*    left: 0;  pointer-events: none;*/
    /*    width: 100%;*/
    /*    right: 0;*/
    /*    height: 35px;*/
    /*    content: " หรือลากไฟล์มาวางที่นี่";*/
    /*    display: block;*/
    /*    margin: 0 auto;*/
    /*    color: #2ea591;*/
    /*    font-weight: 600;*/
    /*    text-transform: capitalize;*/
    /*    text-align: center;*/
    /*}*/

    .files input {
        outline: 2px dashed #9a75b2;
        outline-offset: -10px;
        -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
        transition: outline-offset .15s ease-in-out, background-color .15s linear;
        padding: 120px 0px 90px 37%;
        text-align: center !important;
        margin: 0;
        width: 100% !important;
        opacity: 0;
    }

    .files input.form-control[disabled] {
        opacity: 0;
    }

    .files input:focus {
        outline: 2px dashed #9a75b2;  outline-offset: -10px;
        -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
        transition: outline-offset .15s ease-in-out, background-color .15s linear; border:1px solid #92b0b3;
    }
    .files {
        position:relative;
        outline: 2px dashed #9a75b2;
        outline-offset: -10px;
        -webkit-transition: outline-offset .15s ease-in-out, background-color .15s linear;
        transition: outline-offset .15s ease-in-out, background-color .15s linear;
        text-align: center !important;
        margin: 0;
        width: 100% !important;
        background-color: #fff;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .files:after {
        color: #ffffff;
        pointer-events: none;
        position: absolute;
        top: 15%;
        left: 0;
        right: 0;
        display: block;
        margin: 0 auto;
        content: '\f093';
        font-family: 'FontAwesome';
        font-weight: 900;
        font-size: 40px;
        background-color: #9a75b2;
        border-radius: 50%;
        width: 70px;
        height: 70px;
        padding-top: 5px;
    }
    .color input {
        background-color:#f1f1f1;
    }
    .files:before {
        position: absolute;
        top: 57%;
        left: 0;
        pointer-events: none;
        width: 100%;
        right: 0;
        height: 35px;
        content: "คลิกที่นี่เพื่ออัพโหลดไฟล์\Aหรือ\Aลากไฟล์มาวางที่นี่เพื่ออัพโหลดไฟล์";
        display: block;
        margin: 0 auto;
        color: #9a75b2;
        font-weight: 600;
        text-transform: capitalize;
        text-align: center;
        white-space: pre;
    }

    .progress-bar {
        background-color: #9a74b2;
    }

    .progress-bar {
        color: #ffff;
    }
</style>